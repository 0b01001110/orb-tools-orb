description: >
  Given an source path to a CircleCI config, and the name of an inline orb,
  extract that orb directly from the YAML and write it to the file.
  Optionally, save that file to a workspace and/or artifact.
  Note: this command is designed to run in a an executor with ruby 2.4.x
  and will check to make sure that `gem` is installed.

parameters:
  orb:
    type: string
    description: name of the orb you want to extract

  source:
    type: string
    description: >
      A path to the valid CircleCI config from
      which you want to extract the inline orb.

  file:
    type: string
    description: Path to the file where the orb should be saved
    default: ".circleci/extract-inline-orb/orb.yml"

  save-artifact:
    type: boolean
    default: true
    description: When true (default), save an artifact at `file` path

  save-workspace:
    type: boolean
    default: true
    description: When true (default), save the `file` to the workspace

  workspace-root:
    type: string
    default: "."
    description: >
      In most cases you do not need to change this value. The default is
      the current working directory (`.`). You would only change this if
      your value for `file` is not relative to the root of your working
      directory.

steps:
  # TODO: should validate we're getting good config yaml as an input
  - build-tools/ensure-command:
      command: "gem"

  - run: gem install unindent

  - build-tools/init-file:
      file: << parameters.file >>

  - build-tools/script-run:
      label: "Extract the orb `<< parameters.orb >>` and write it to: << parameters.file >> "
      script: <<include(scripts/extract-inline-orb.sh)>>

  - when:
      condition: << parameters.save-artifact >>
      steps:
        - store_artifacts:
            path: << parameters.file >>

  - when:
      condition: << parameters.save-workspace >>
      steps:
        - persist_to_workspace:
            root: << parameters.workspace-root >>
            paths:
              - << parameters.file >>

  - run:
      name: Display extracted orb
      command: cat "<< parameters.file >>"
